<script>
const PASSWORD = "3490";
let input = "";

function press(n){ input+=n; display.value=input }
function clearDisplay(){ input=""; display.value="" }
function checkPassword(){
  if(input===PASSWORD){
    lockScreen.style.display="none";
    cameraContainer.style.display="block";
    controls.style.display="flex";
    startCamera();
  } else { alert("Wrong password"); clearDisplay(); }
}

const video = document.getElementById("video");
const overlay = document.getElementById("overlayImage");
const zoomSlider = document.getElementById("zoomSlider");
const opacitySlider = document.getElementById("opacitySlider");
const photoBtn = document.getElementById("photoBtn");
const linkZoomBtn = document.getElementById("linkZoomBtn");

let originX=0, originY=0, scale=1, rotation=0;
let targetX=0, targetY=0, targetScale=1, targetRotation=0;

let startDistance=0, startAngle=0, lastTouch=null;
let videoTrack=null, supportsRealZoom=false;
let linkZoom=false;

function lerp(a,b,t){ return a+(b-a)*t }

function applyTransform(){
  overlay.style.transform =
    `translate(-50%, -50%)
     translate(${originX}px, ${originY}px)
     scale(${scale})
     rotate(${rotation}deg)`;
}

function animate(){
  originX=lerp(originX,targetX,.15);
  originY=lerp(originY,targetY,.15);
  scale=lerp(scale,targetScale,.15);
  rotation=lerp(rotation,targetRotation,.15);
  applyTransform();
  requestAnimationFrame(animate);
}
animate();

async function startCamera(){
  const stream = await navigator.mediaDevices.getUserMedia({
    video:{facingMode:{exact:"environment"}}
  });
  video.srcObject=stream;
  videoTrack=stream.getVideoTracks()[0];
  const cap=videoTrack.getCapabilities();
  const settings=videoTrack.getSettings();

  if(cap.zoom){
    supportsRealZoom=true;
    zoomSlider.min=cap.zoom.min;
    zoomSlider.max=cap.zoom.max;
    zoomSlider.step=cap.zoom.step;
    zoomSlider.value=settings.zoom || cap.zoom.min;

    zoomSlider.oninput=()=>{
      videoTrack.applyConstraints({
        advanced:[{zoom:parseFloat(zoomSlider.value)}]
      });
    };
  }
}

photoBtn.onclick=()=>{
  const i=document.createElement("input");
  i.type="file"; i.accept="image/*";
  i.onchange=e=>{
    overlay.src=URL.createObjectURL(e.target.files[0]);
    overlay.style.display="block";
    targetX=targetY=0;
    targetScale=1;
    targetRotation=0;
  };
  i.click();
};

opacitySlider.oninput=()=>overlay.style.opacity=opacitySlider.value;

linkZoomBtn.onclick=()=>{
  linkZoom=!linkZoom;
  linkZoomBtn.textContent=linkZoom?"Unlink Zoom":"Link Zoom";
};

/* ------------------ TOUCH HANDLING ------------------ */

overlay.addEventListener("touchstart",e=>{
  if(e.touches.length===1){
    lastTouch=e.touches[0];
  }
  if(e.touches.length===2){
    const [a,b]=e.touches;
    startDistance=Math.hypot(a.clientX-b.clientX,a.clientY-b.clientY);
    startAngle=Math.atan2(
      a.clientY-b.clientY,
      a.clientX-b.clientX
    )*180/Math.PI;
  }
});

overlay.addEventListener("touchmove",e=>{
  e.preventDefault();

  /* DRAG — only when NOT linked */
  if(e.touches.length===1 && lastTouch && !linkZoom){
    targetX+=e.touches[0].clientX-lastTouch.clientX;
    targetY+=e.touches[0].clientY-lastTouch.clientY;
    lastTouch=e.touches[0];
  }

  /* PINCH */
  if(e.touches.length===2){
    const [a,b]=e.touches;
    const dist=Math.hypot(a.clientX-b.clientX,a.clientY-b.clientY);
    const factor=dist/startDistance;

    /* SCALE — always allowed */
    targetScale=Math.max(0.1,Math.min(targetScale*factor,10));

    /* ROTATION — only when NOT linked */
    if(!linkZoom){
      const angle=Math.atan2(
        a.clientY-b.clientY,
        a.clientX-b.clientX
      )*180/Math.PI;
      targetRotation+=angle-startAngle;
      startAngle=angle;
    }

    /* CAMERA ZOOM — only when linked */
    if(linkZoom && supportsRealZoom){
      const camZoom=Math.max(
        zoomSlider.min,
        Math.min(targetScale,zoomSlider.max)
      );
      videoTrack.applyConstraints({
        advanced:[{zoom:camZoom}]
      });
      zoomSlider.value=camZoom;
    }

    startDistance=dist;
  }
},{passive:false});
</script>
