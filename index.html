<script>
/* ---------- LOCK ---------- */
const PASSWORD="3490";
let input="";
function press(n){ input+=n; display.value=input }
function clearDisplay(){ input=""; display.value="" }
function checkPassword(){
  if(input===PASSWORD){
    lockScreen.style.display="none";
    cameraContainer.style.display="block";
    controls.style.display="flex";
    startCamera();
    restoreState();
  } else { clearDisplay(); }
}

/* ---------- ELEMENTS ---------- */
const video=document.getElementById("video");
const overlay=document.getElementById("overlayImage");
const zoomSlider=document.getElementById("zoomSlider");
const opacitySlider=document.getElementById("opacitySlider");
const photoBtn=document.getElementById("photoBtn");
const linkZoomBtn=document.getElementById("linkZoomBtn");

/* ---------- STATE ---------- */
let x=0,y=0,scale=1,rot=0;
let tx=0,ty=0,ts=1,tr=0;
let lastTouch=null,startDist=0,startAngle=0;
let linkZoom=false;
let track,cap,camMin,camMax;
let baseCamZoom=1,baseScale=1;

/* ---------- SMOOTHING ---------- */
function lerp(a,b){ return a+(b-a)*.18 }
function animate(){
  x=lerp(x,tx); y=lerp(y,ty);
  scale=lerp(scale,ts);
  rot=lerp(rot,tr);
  overlay.style.transform=
    `translate(-50%,-50%) translate(${x}px,${y}px) scale(${scale}) rotate(${rot}deg)`;
  requestAnimationFrame(animate);
}
animate();

/* ---------- CAMERA ---------- */
async function startCamera(){
  const stream=await navigator.mediaDevices.getUserMedia({
    video:{facingMode:{exact:"environment"}}
  });
  video.srcObject=stream;
  track=stream.getVideoTracks()[0];
  cap=track.getCapabilities();
  const settings=track.getSettings();

  camMin=cap.zoom.min;
  camMax=cap.zoom.max;

  zoomSlider.min=camMin;
  zoomSlider.max=camMax;
  zoomSlider.step=cap.zoom.step;
  zoomSlider.value=settings.zoom ?? camMin;

  track.applyConstraints({advanced:[{zoom:zoomSlider.value}]});

  zoomSlider.oninput=()=>{
    const z=parseFloat(zoomSlider.value);
    track.applyConstraints({advanced:[{zoom:z}]});
    saveState();
  };
}

/* ---------- IMAGE PICKER (FIXED) ---------- */
photoBtn.onclick=()=>{
  const input=document.createElement("input");
  input.type="file";
  input.accept="image/*";
  input.onchange=e=>{
    const file=e.target.files[0];
    if(!file) return;
    overlay.src=URL.createObjectURL(file);
    overlay.style.display="block";
    ts=scale=1; tr=rot=0; tx=x=0; ty=y=0;
    saveState();
  };
  input.click();
};

/* ---------- UI ---------- */
opacitySlider.oninput=()=>{
  overlay.style.opacity=opacitySlider.value;
  saveState();
};

linkZoomBtn.onclick=()=>{
  linkZoom=!linkZoom;
  linkZoomBtn.textContent=linkZoom?"Unlink":"Link";
};

/* ---------- TOUCH ---------- */
overlay.addEventListener("touchstart",e=>{
  if(e.touches.length===1) lastTouch=e.touches[0];
  if(e.touches.length===2){
    const [a,b]=e.touches;
    startDist=Math.hypot(a.clientX-b.clientX,a.clientY-b.clientY);
    startAngle=Math.atan2(a.clientY-b.clientY,a.clientX-b.clientX);
    baseCamZoom=parseFloat(zoomSlider.value);
    baseScale=ts;
  }
});

overlay.addEventListener("touchmove",e=>{
  e.preventDefault();

  if(e.touches.length===1 && lastTouch && !linkZoom){
    tx+=e.touches[0].clientX-lastTouch.clientX;
    ty+=e.touches[0].clientY-lastTouch.clientY;
    lastTouch=e.touches[0];
  }

  if(e.touches.length===2){
    const [a,b]=e.touches;
    const d=Math.hypot(a.clientX-b.clientX,a.clientY-b.clientY);
    const factor=d/startDist;

    if(linkZoom){
      let newZoom=baseCamZoom*factor;
      newZoom=Math.max(camMin,Math.min(newZoom,camMax));
      track.applyConstraints({advanced:[{zoom:newZoom}]});
      zoomSlider.value=newZoom;
      ts=baseScale*(newZoom/baseCamZoom || 1);
    } else {
      ts=Math.max(.1,Math.min(ts*factor,10));
      const ang=Math.atan2(a.clientY-b.clientY,a.clientX-b.clientX);
      tr+=(ang-startAngle)*180/Math.PI;
      startAngle=ang;
    }
    startDist=d;
  }
},{passive:false});

/* ---------- MEMORY ---------- */
function saveState(){
  localStorage.setItem("overlayState",JSON.stringify({
    x,y,scale,rot,
    opacity:overlay.style.opacity,
    zoom:zoomSlider.value,
    img:overlay.src
  }));
}

function restoreState(){
  const s=JSON.parse(localStorage.getItem("overlayState")||"null");
  if(!s) return;
  x=tx=s.x; y=ty=s.y;
  scale=ts=s.scale; rot=tr=s.rot;
  overlay.style.opacity=s.opacity;
  overlay.src=s.img;
  overlay.style.display=s.img?"block":"none";
  zoomSlider.value=s.zoom;
  track?.applyConstraints({advanced:[{zoom:parseFloat(s.zoom)}]});
}
</script>
